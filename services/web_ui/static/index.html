<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saga Pattern - Event-Driven Order Processing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse-success {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        @keyframes pulse-error {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .pulse-success { animation: pulse-success 2s infinite; }
        .pulse-error { animation: pulse-error 2s infinite; }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .saga-flow-line {
            position: relative;
        }

        .saga-flow-line::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 2px;
            height: 30px;
            background: #e5e7eb;
            transform: translateX(-50%);
        }

        .saga-flow-line:last-child::after {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="sagaDashboard()">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        <i class="fas fa-network-wired mr-3"></i>
                        Event-Driven Order Processing
                    </h1>
                    <p class="text-purple-200 mt-1">Saga Pattern Microservices Dashboard</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="refreshAll()" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition flex items-center">
                        <i class="fas fa-sync-alt mr-2" :class="{'fa-spin': loading}"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Service Health Status -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-heartbeat mr-2 text-red-500"></i>
                Service Health
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <template x-for="(health, service) in serviceHealth" :key="service">
                    <div class="border rounded-lg p-4 text-center transition hover:shadow-md">
                        <div class="text-sm text-gray-500 mb-2 capitalize" x-text="service"></div>
                        <div class="flex items-center justify-center">
                            <span class="status-indicator"
                                  :class="{
                                      'bg-green-500': health.status === 'healthy',
                                      'bg-red-500': health.status === 'unhealthy',
                                      'bg-gray-400': health.status === 'unreachable'
                                  }"></span>
                            <span class="font-semibold" x-text="health.status"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Order Creation -->
            <div class="lg:col-span-1">
                <!-- Create Order -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-shopping-cart mr-2 text-blue-500"></i>
                        Create Order
                    </h2>

                    <form @submit.prevent="createOrder()">
                        <!-- Product Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                            <select x-model="orderForm.productId" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">Select a product...</option>
                                <template x-for="product in products" :key="product.id">
                                    <option :value="product.id" x-text="`${product.name} - $${product.price} (${product.available_quantity} available)`"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" x-model="orderForm.quantity" min="1"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2"
                                   placeholder="Enter quantity">
                        </div>

                        <!-- Shipping Address -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Address</label>
                            <input type="text" x-model="orderForm.address.street"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-2"
                                   placeholder="Street">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" x-model="orderForm.address.city"
                                       class="border border-gray-300 rounded-lg px-3 py-2"
                                       placeholder="City">
                                <input type="text" x-model="orderForm.address.state"
                                       class="border border-gray-300 rounded-lg px-3 py-2"
                                       placeholder="State">
                            </div>
                            <input type="text" x-model="orderForm.address.zip"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 mt-2"
                                   placeholder="ZIP Code">
                        </div>

                        <!-- Submit Button -->
                        <button type="submit"
                                :disabled="!orderForm.productId || orderForm.quantity < 1 || creatingOrder"
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!creatingOrder">
                                <i class="fas fa-rocket mr-2"></i>Place Order
                            </span>
                            <span x-show="creatingOrder">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Creating Order...
                            </span>
                        </button>
                    </form>

                    <!-- Success/Error Message -->
                    <div x-show="orderMessage"
                         :class="{
                             'bg-green-50 border-green-200 text-green-800': orderSuccess,
                             'bg-red-50 border-red-200 text-red-800': !orderSuccess
                         }"
                         class="mt-4 p-4 border rounded-lg slide-in">
                        <p class="font-semibold" x-text="orderMessage"></p>
                        <p x-show="currentOrderId" class="text-sm mt-1">
                            Order ID: <span class="font-mono" x-text="currentOrderId"></span>
                        </p>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-green-500"></i>
                        Real-time Metrics
                    </h2>

                    <div class="space-y-4">
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Orders</span>
                                <span class="text-2xl font-bold text-blue-600" x-text="metrics.total_orders"></span>
                            </div>
                        </div>
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Confirmed</span>
                                <span class="text-2xl font-bold text-green-600" x-text="metrics.confirmed_orders"></span>
                            </div>
                        </div>
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Failed</span>
                                <span class="text-2xl font-bold text-red-600" x-text="metrics.failed_orders"></span>
                            </div>
                        </div>
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Revenue</span>
                                <span class="text-2xl font-bold text-purple-600">$<span x-text="metrics.total_revenue?.toFixed(2)"></span></span>
                            </div>
                        </div>
                        <div class="border-b pb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Payment Success Rate</span>
                                <span class="text-2xl font-bold text-indigo-600" x-text="metrics.payment_success_rate + '%'"></span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Avg Order Value</span>
                                <span class="text-2xl font-bold text-orange-600">$<span x-text="metrics.average_order_value?.toFixed(2)"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Saga Visualization & Events -->
            <div class="lg:col-span-2">
                <!-- Saga Flow Visualization -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-project-diagram mr-2 text-purple-500"></i>
                        Saga Flow Tracker
                    </h2>

                    <!-- Order ID Input -->
                    <div class="mb-6 flex gap-2">
                        <input type="text"
                               x-model="trackOrderId"
                               @keyup.enter="trackOrder()"
                               class="flex-1 border border-gray-300 rounded-lg px-4 py-2"
                               placeholder="Enter Order ID to track saga...">
                        <button @click="trackOrder()"
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-search"></i> Track
                        </button>
                    </div>

                    <!-- Saga Flow -->
                    <div x-show="trackedOrder" class="space-y-4">
                        <!-- Order Status -->
                        <div class="bg-gray-50 rounded-lg p-4 border-l-4"
                             :class="{
                                 'border-green-500': trackedOrder?.status === 'confirmed',
                                 'border-red-500': trackedOrder?.status === 'failed',
                                 'border-yellow-500': trackedOrder?.status === 'pending' || trackedOrder?.status === 'inventory_reserved' || trackedOrder?.status === 'payment_processing',
                                 'border-gray-500': !trackedOrder
                             }">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">Order Status</h3>
                                    <p class="text-gray-600 text-sm">Order ID: <span class="font-mono" x-text="trackedOrder?.id"></span></p>
                                </div>
                                <div>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold uppercase"
                                          :class="{
                                              'bg-green-100 text-green-800': trackedOrder?.status === 'confirmed',
                                              'bg-red-100 text-red-800': trackedOrder?.status === 'failed',
                                              'bg-yellow-100 text-yellow-800': trackedOrder?.status === 'pending' || trackedOrder?.status === 'inventory_reserved' || trackedOrder?.status === 'payment_processing'
                                          }"
                                          x-text="trackedOrder?.status"></span>
                                </div>
                            </div>
                            <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Amount:</span>
                                    <span class="font-semibold ml-2">$<span x-text="trackedOrder?.total_amount?.toFixed(2)"></span></span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Items:</span>
                                    <span class="font-semibold ml-2" x-text="trackedOrder?.items?.length"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Saga Steps -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="font-semibold text-lg mb-4">Saga Execution Steps</h3>
                            <div class="space-y-4">
                                <template x-for="(log, index) in sagaLogs" :key="log.id">
                                    <div class="saga-flow-line">
                                        <div class="flex items-start gap-4 bg-white rounded-lg p-4 shadow-sm border">
                                            <div class="flex-shrink-0 mt-1">
                                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-semibold"
                                                     :class="{
                                                         'bg-green-100 text-green-600': log.status === 'completed',
                                                         'bg-red-100 text-red-600': log.status === 'failed',
                                                         'bg-yellow-100 text-yellow-600': log.status === 'started',
                                                         'bg-blue-100 text-blue-600': log.status === 'compensated'
                                                     }">
                                                    <i class="fas" :class="{
                                                        'fa-check': log.status === 'completed',
                                                        'fa-times': log.status === 'failed',
                                                        'fa-spinner fa-spin': log.status === 'started',
                                                        'fa-undo': log.status === 'compensated'
                                                    }"></i>
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h4 class="font-semibold capitalize" x-text="log.step.replace('_', ' ')"></h4>
                                                        <p class="text-sm text-gray-600" x-text="log.event_type"></p>
                                                    </div>
                                                    <span class="text-xs px-2 py-1 rounded-full"
                                                          :class="{
                                                              'bg-green-100 text-green-800': log.status === 'completed',
                                                              'bg-red-100 text-red-800': log.status === 'failed',
                                                              'bg-yellow-100 text-yellow-800': log.status === 'started',
                                                              'bg-blue-100 text-blue-800': log.status === 'compensated'
                                                          }"
                                                          x-text="log.status"></span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1" x-text="new Date(log.created_at).toLocaleString()"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Service Details -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Inventory -->
                            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <h4 class="font-semibold mb-2 flex items-center">
                                    <i class="fas fa-boxes mr-2 text-blue-600"></i>
                                    Inventory
                                </h4>
                                <div x-show="reservation" class="text-sm space-y-1">
                                    <p><span class="text-gray-600">Status:</span> <span class="font-semibold" x-text="reservation?.status"></span></p>
                                    <p><span class="text-gray-600">Items:</span> <span class="font-semibold" x-text="reservation?.items?.length"></span></p>
                                </div>
                                <p x-show="!reservation" class="text-sm text-gray-500">No reservation</p>
                            </div>

                            <!-- Payment -->
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                <h4 class="font-semibold mb-2 flex items-center">
                                    <i class="fas fa-credit-card mr-2 text-green-600"></i>
                                    Payment
                                </h4>
                                <div x-show="transaction" class="text-sm space-y-1">
                                    <p><span class="text-gray-600">Status:</span> <span class="font-semibold" x-text="transaction?.status"></span></p>
                                    <p><span class="text-gray-600">Amount:</span> <span class="font-semibold">$<span x-text="transaction?.amount?.toFixed(2)"></span></span></p>
                                </div>
                                <p x-show="!transaction" class="text-sm text-gray-500">No transaction</p>
                            </div>

                            <!-- Shipping -->
                            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                <h4 class="font-semibold mb-2 flex items-center">
                                    <i class="fas fa-truck mr-2 text-purple-600"></i>
                                    Shipping
                                </h4>
                                <div x-show="shipment" class="text-sm space-y-1">
                                    <p><span class="text-gray-600">Status:</span> <span class="font-semibold" x-text="shipment?.status"></span></p>
                                    <p><span class="text-gray-600">Tracking:</span> <span class="font-mono text-xs" x-text="shipment?.tracking_number"></span></p>
                                </div>
                                <p x-show="!shipment" class="text-sm text-gray-500">Not shipped</p>
                            </div>
                        </div>
                    </div>

                    <div x-show="!trackedOrder" class="text-center py-12 text-gray-400">
                        <i class="fas fa-search fa-3x mb-4"></i>
                        <p>Enter an Order ID to track its saga flow</p>
                    </div>
                </div>

                <!-- Event Statistics -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-orange-500"></i>
                        Event Statistics
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <template x-for="stat in eventStats" :key="stat.event_type">
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border">
                                <div class="text-sm text-gray-600 mb-1 truncate" x-text="stat.event_type"></div>
                                <div class="text-2xl font-bold text-gray-800" x-text="stat.count"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function sagaDashboard() {
            return {
                loading: false,
                serviceHealth: {},
                products: [],
                metrics: {},
                eventStats: [],

                // Order form
                orderForm: {
                    productId: '',
                    quantity: 1,
                    address: {
                        street: '123 Main St',
                        city: 'San Francisco',
                        state: 'CA',
                        zip: '94102'
                    }
                },
                creatingOrder: false,
                orderMessage: '',
                orderSuccess: false,
                currentOrderId: '',

                // Tracking
                trackOrderId: '',
                trackedOrder: null,
                sagaLogs: [],
                reservation: null,
                transaction: null,
                shipment: null,

                async init() {
                    await this.refreshAll();
                    // Auto-refresh every 5 seconds
                    setInterval(() => {
                        this.checkHealth();
                        this.loadMetrics();
                        this.loadEventStats();
                        if (this.trackOrderId) {
                            this.trackOrder();
                        }
                    }, 5000);
                },

                async refreshAll() {
                    this.loading = true;
                    await Promise.all([
                        this.checkHealth(),
                        this.loadProducts(),
                        this.loadMetrics(),
                        this.loadEventStats()
                    ]);
                    this.loading = false;
                },

                async checkHealth() {
                    try {
                        const response = await fetch('/api/health');
                        this.serviceHealth = await response.json();
                    } catch (error) {
                        console.error('Health check failed:', error);
                    }
                },

                async loadProducts() {
                    try {
                        const response = await fetch('/api/products');
                        this.products = await response.json();
                    } catch (error) {
                        console.error('Failed to load products:', error);
                    }
                },

                async loadMetrics() {
                    try {
                        const response = await fetch('/api/metrics');
                        this.metrics = await response.json();
                    } catch (error) {
                        console.error('Failed to load metrics:', error);
                    }
                },

                async loadEventStats() {
                    try {
                        const response = await fetch('/api/events/stats');
                        this.eventStats = await response.json();
                    } catch (error) {
                        console.error('Failed to load event stats:', error);
                    }
                },

                async createOrder() {
                    if (!this.orderForm.productId || this.orderForm.quantity < 1) {
                        return;
                    }

                    this.creatingOrder = true;
                    this.orderMessage = '';

                    try {
                        const product = this.products.find(p => p.id === this.orderForm.productId);

                        const response = await fetch('/api/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                customer_id: '123e4567-e89b-12d3-a456-426614174000',
                                items: [{
                                    product_id: this.orderForm.productId,
                                    quantity: this.orderForm.quantity,
                                    price: product.price
                                }],
                                shipping_address: this.orderForm.address,
                                payment_method: {
                                    type: 'credit_card'
                                }
                            })
                        });

                        if (response.ok) {
                            const order = await response.json();
                            this.orderSuccess = true;
                            this.orderMessage = 'Order created successfully!';
                            this.currentOrderId = order.id;
                            this.trackOrderId = order.id;

                            // Auto-track after 2 seconds
                            setTimeout(() => {
                                this.trackOrder();
                            }, 2000);

                            // Reset form
                            this.orderForm.quantity = 1;

                            // Refresh data
                            await this.loadProducts();
                            await this.loadMetrics();
                        } else {
                            const error = await response.text();
                            this.orderSuccess = false;
                            this.orderMessage = `Failed to create order: ${error}`;
                        }
                    } catch (error) {
                        this.orderSuccess = false;
                        this.orderMessage = `Error: ${error.message}`;
                    } finally {
                        this.creatingOrder = false;

                        // Clear message after 5 seconds
                        setTimeout(() => {
                            this.orderMessage = '';
                        }, 5000);
                    }
                },

                async trackOrder() {
                    if (!this.trackOrderId) return;

                    try {
                        // Load order details
                        const orderResponse = await fetch(`/api/orders/${this.trackOrderId}`);
                        if (orderResponse.ok) {
                            this.trackedOrder = await orderResponse.json();
                        }

                        // Load saga logs
                        const logsResponse = await fetch(`/api/orders/${this.trackOrderId}/saga-logs`);
                        if (logsResponse.ok) {
                            this.sagaLogs = await logsResponse.json();
                        }

                        // Load service details
                        const [reservationRes, transactionRes, shipmentRes] = await Promise.all([
                            fetch(`/api/reservations/${this.trackOrderId}`),
                            fetch(`/api/transactions/${this.trackOrderId}`),
                            fetch(`/api/shipments/${this.trackOrderId}`)
                        ]);

                        this.reservation = reservationRes.ok ? await reservationRes.json() : null;
                        this.transaction = transactionRes.ok ? await transactionRes.json() : null;
                        this.shipment = shipmentRes.ok ? await shipmentRes.json() : null;

                    } catch (error) {
                        console.error('Failed to track order:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
